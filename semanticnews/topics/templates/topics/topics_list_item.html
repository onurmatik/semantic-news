{% load i18n markdown_extras json_extras %}

<div class="position-relative mb-3 pb-3 border-bottom" data-topic-uuid="{{ topic.uuid }}">

    <h1 class="d-flex fs-4 w-100">

        <a href="{{ topic.get_absolute_url }}"
           class="text-body text-decoration-none">{{ topic.display_title }}
        </a>

        <small class="d-flex fs-5 ms-auto mt-1">

            <a href="#" data-bs-toggle="tooltip" data-bs-title="{% trans "Bookmark this topic" %}"
               class="text-info-emphasis bi bi-bookmark"
            ></a>

            <a href="#" data-bs-toggle="tooltip" data-bs-title="{% trans "Copy link" %}"
               class="text-info-emphasis bi bi-link copy-link ms-1"
               data-url="{{ topic.get_absolute_url }}"></a>

        </small>

    </h1>

    <p class="me-auto mb-3 text-secondary small">

        {% url 'user_profile' username=topic.created_by.username as user_topics_url %}

        {% if topic.last_published_at %}
            {% blocktrans with created_date=topic.created_at|date created_by=topic.created_by.profile last_published_ago=topic.last_published_at|timesince %}Created on {{ created_date }} by <a class="text-info-emphasis" href="{{ user_topics_url }}">{{ created_by }}</a>; last published {{ last_published_ago }} ago.{% endblocktrans %}
        {% else %}
            {% blocktrans with created_date=topic.created_at|date created_by=topic.created_by.profile %}Created on {{ created_date }} by <a class="text-info-emphasis" href="{{ user_topics_url }}">{{ created_by }}</a>; not yet published.{% endblocktrans %}
        {% endif %}
        {% if topic.status == "draft" %}
            <span class="badge bg-warning  pill ms-1">{% trans "Draft" %}</span>
        {% elif topic.status == "archived" %}
            <span class="badge bg-secondary  pill ms-1">{% trans "Archived" %}</span>
        {% endif %}

    </p>

    <div class="position-relative clearfix">

        <a href="{{ topic.get_absolute_url }}" class="stretched-link"></a>

        {% with hero=topic.thumbnail %}
            {% if hero %}
                <img src="{{ hero.url }}" alt="{{ topic.display_title }}" class="img-fluid rounded mb-2 float-start me-3 w-50">
            {% else %}
                {% with first_visualization=topic.active_data_visualizations.all|first %}
                    {% if first_visualization %}
                        <div
                            class="chart-container rounded border mb-2 float-start me-3 w-50 bg-body"
                            data-visualization-preview="{{ first_visualization.id }}"
                        >
                            <canvas
                                id="dataVisualizationChart{{ first_visualization.id }}"
                                class="data-visualization-chart w-100"
                                data-chart-type="{{ first_visualization.chart_type }}"
                                data-chart="{{ first_visualization.chart_data|jsonify }}"
                            ></canvas>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endif %}
        {% endwith %}

        {% with latest_recap=topic.active_recaps.last %}
            {% if latest_recap %}
                <div class="small text-body">{{ latest_recap.recap|markdownify }}</div>
            {% endif %}
        {% endwith %}

    </div>

</div>
