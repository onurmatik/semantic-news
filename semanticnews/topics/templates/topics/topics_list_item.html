{% load i18n markdown_extras json_extras %}

<div class="position-relative mb-3 pb-3 border-bottom" data-topic-uuid="{{ topic.uuid }}">

    <h1 class="d-flex fs-4 w-100">

        <a href="{{ topic.get_absolute_url }}"
           class="text-body text-decoration-none">{{ topic.title }}
        </a>

        <small class="d-flex fs-5 ms-auto mt-1">

            <a href="#" data-bs-toggle="tooltip" data-bs-title="{% trans "Bookmark this topic" %}"
               class="text-info-emphasis bi bi-bookmark"
            ></a>

            <a href="#" data-bs-toggle="tooltip" data-bs-title="{% trans "Copy link" %}"
               class="text-info-emphasis bi bi-link copy-link ms-1"
               data-url="{{ topic.get_absolute_url }}"></a>

        </small>

    </h1>

    <p class="me-auto mb-3 text-secondary small">

        {% url 'user_profile' username=topic.created_by.username as user_topics_url %}

        {% blocktrans with created_date=topic.created_at|date created_by=topic.created_by.profile modified_ago=topic.updated_at|timesince %}Created on {{ created_date }} by <a class="text-info-emphasis" href="{{ user_topics_url }}">{{ created_by }}</a>; updated {{ modified_ago }} ago.{% endblocktrans %}
        {% with item_count=topic.contents.count contributor_count=topic.contributors.count %}
            <nobr>
                {% if item_count > 0 %}
                    {% blocktrans count item_count=item_count %}{{ item_count }} item{% plural %}{{ item_count }} items{% endblocktrans %}
                {% endif %}
            </nobr>
        {% endwith %}

        {% if topic.status == "draft" %}
            <span class="badge bg-warning  pill ms-1">{% trans "Draft" %}</span>
        {% elif topic.status == "archived" %}
            <span class="badge bg-secondary  pill ms-1">{% trans "Archived" %}</span>
        {% endif %}

    </p>

    <div class="position-relative">

        <a href="{{ topic.get_absolute_url }}" class="stretched-link"></a>

        {% with publication=topic.latest_publication %}
            {% if publication %}
                {% with snapshot=publication.context_snapshot %}
                    {% if snapshot %}
                        {% with image=snapshot.image %}
                            {% if image %}
                                {% if image.thumbnail_url %}
                                    <img src="{{ image.thumbnail_url }}" alt="{{ topic.title }}" class="img-fluid rounded mb-2 float-start me-3 w-50">
                                {% elif image.image_url %}
                                    <img src="{{ image.image_url }}" alt="{{ topic.title }}" class="img-fluid rounded mb-2 float-start me-3 w-50">
                                {% else %}
                                    {% with first_visualization=snapshot.data_visualizations|first %}
                                        {% if first_visualization %}
                                            <div
                                                class="chart-container rounded border mb-2 float-start me-3 w-50 bg-body"
                                                data-visualization-preview="{{ first_visualization.id }}"
                                            >
                                                <canvas
                                                    id="dataVisualizationChart{{ first_visualization.id }}"
                                                    class="data-visualization-chart w-100"
                                                    data-chart-type="{{ first_visualization.chart_type }}"
                                                    data-chart="{{ first_visualization.chart_data|jsonify }}"
                                                ></canvas>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            {% else %}
                                {% with first_visualization=snapshot.data_visualizations|first %}
                                    {% if first_visualization %}
                                        <div
                                            class="chart-container rounded border mb-2 float-start me-3 w-50 bg-body"
                                            data-visualization-preview="{{ first_visualization.id }}"
                                        >
                                            <canvas
                                                id="dataVisualizationChart{{ first_visualization.id }}"
                                                class="data-visualization-chart w-100"
                                                data-chart-type="{{ first_visualization.chart_type }}"
                                                data-chart="{{ first_visualization.chart_data|jsonify }}"
                                            ></canvas>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        {% endwith %}

                        {% with latest_recap=snapshot.latest_recap %}
                            {% if latest_recap %}
                                <div class="small text-body">{{ latest_recap.recap|markdownify }}</div>
                            {% elif snapshot.recaps %}
                                {% with fallback_recap=snapshot.recaps|first %}
                                    {% if fallback_recap %}
                                        <div class="small text-body">{{ fallback_recap.recap|markdownify }}</div>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        {% if topic.thumbnail %}
                            <img src="{{ topic.thumbnail.url }}" alt="{{ topic.title }}" class="img-fluid rounded mb-2 float-start me-3 w-50">
                        {% else %}
                            {% with topic.active_data_visualizations.all|first as first_visualization %}
                                {% if first_visualization %}
                                    <div
                                        class="chart-container rounded border mb-2 float-start me-3 w-50 bg-body"
                                        data-visualization-preview="{{ first_visualization.id }}"
                                    >
                                        <canvas
                                            id="dataVisualizationChart{{ first_visualization.id }}"
                                            class="data-visualization-chart w-100"
                                            data-chart-type="{{ first_visualization.chart_type }}"
                                            data-chart="{{ first_visualization.chart_data|jsonify }}"
                                        ></canvas>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}

                        {% with topic.active_recaps.last as latest_recap %}
                            {% if latest_recap %}
                                <div class="small text-body">{{ latest_recap.recap|markdownify }}</div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                {% endwith %}
            {% else %}
                {% if topic.thumbnail %}
                    <img src="{{ topic.thumbnail.url }}" alt="{{ topic.title }}" class="img-fluid rounded mb-2 float-start me-3 w-50">
                {% else %}
                    {% with topic.active_data_visualizations.all|first as first_visualization %}
                        {% if first_visualization %}
                            <div
                                class="chart-container rounded border mb-2 float-start me-3 w-50 bg-body"
                                data-visualization-preview="{{ first_visualization.id }}"
                            >
                                <canvas
                                    id="dataVisualizationChart{{ first_visualization.id }}"
                                    class="data-visualization-chart w-100"
                                    data-chart-type="{{ first_visualization.chart_type }}"
                                    data-chart="{{ first_visualization.chart_data|jsonify }}"
                                ></canvas>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}

                {% with topic.active_recaps.last as latest_recap %}
                    {% if latest_recap %}
                        <div class="small text-body">{{ latest_recap.recap|markdownify }}</div>
                    {% endif %}
                {% endwith %}
            {% endif %}
        {% endwith %}

    </div>

</div>
