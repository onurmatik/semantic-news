{% extends "base.html" %}

{% load static i18n humanize markdown_extras topic_layout %}

{% block title %}{{ topic.display_title }}{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    {% if canonical_url %}
        <link rel="canonical" href="{{ canonical_url }}">
        <meta property="og:url" content="{{ canonical_url }}">
    {% endif %}
    <meta name="description" content="{{ meta_description|default:topic.title }}">
    <meta property="og:type" content="{{ open_graph_type|default:'article' }}">
    <meta property="og:title" content="{{ meta_title|default:topic.title }}">
    <meta property="og:description" content="{{ meta_description|default:topic.title }}">
    {% if meta_site_name %}
        <meta property="og:site_name" content="{{ meta_site_name|default:'Semantic News' }}">
    {% endif %}
    {% if og_image_url %}
        <meta property="og:image" content="{{ og_image_url }}">
    {% endif %}
    <meta name="twitter:card" content="{{ twitter_card|default:'summary' }}">
    <meta name="twitter:title" content="{{ meta_title|default:topic.title }}">
    <meta name="twitter:description" content="{{ meta_description|default:topic.title }}">
    {% if og_image_url %}
        <meta name="twitter:image" content="{{ og_image_url }}">
    {% endif %}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between pb-2 align-items-start">

    <div data-topic-uuid="{{ topic.uuid }}">

        <h3 class="fs-5 d-flex align-items-center">

            <span class="d-md-inline">
            {% for keyword in topic.categories.all %}
                <a href="{% url 'topics_detail' slug=keyword.slug %}" class="text-info-emphasis text-decoration-none">{{ keyword.name }}</a>
                {% if not forloop.last %}
                    &middot;
                {% endif %}
            {% endfor %}
            </span>

        </h3>

        <h1 class="fs-3">

            {{ topic.display_title }}

            {% if is_preview %}
                <small class="badge bg-info text-dark ms-2 fs-6">{% trans "Preview" %}</small>
            {% else %}
                <small class="fs-5 ms-2">

                    <a href="#" data-bs-toggle="tooltip" data-bs-title="{% trans "Bookmark this topic" %}"
                       class="text-info-emphasis bi bi-bookmark"
                    ></a>

                    <a href="#" data-bs-toggle="tooltip" data-bs-title="{% trans "Copy link" %}"
                       class="text-info-emphasis bi bi-link copy-link ms-1"
                       data-url="{{ topic.get_absolute_url }}"></a>

                </small>
            {% endif %}

        </h1>

        <div class="d-flex align-items-center">

            <p class="text-secondary small">

                {% url 'user_profile' username=topic.created_by.username as user_topics_url %}
                {% if topic.last_published_at %}
                    {% if topic.based_on %}
                        {% url 'topics_detail' username=topic.based_on.created_by.username slug=topic.based_on.slug as based_on_url %}
                        {% blocktrans with created_date=topic.created_at|date created_by=topic.created_by last_published_ago=topic.last_published_at|timesince based_on_user=topic.based_on.created_by %}Created by <a class="text-info-emphasis" href="{{ user_topics_url }}">{{ created_by }}</a> on {{ created_date }}; last published {{ last_published_ago }} ago; based on <a class="text-info-emphasis" href="{{ based_on_url }}">{{ based_on_user }}'s version</a>.{% endblocktrans %}
                    {% else %}
                        {% blocktrans with created_date=topic.created_at|date created_by=topic.created_by last_published_ago=topic.last_published_at|timesince %}Created by <a class="text-info-emphasis" href="{{ user_topics_url }}">{{ created_by }}</a> on {{ created_date }}; last published {{ last_published_ago }} ago.{% endblocktrans %}
                    {% endif %}
                {% else %}
                    {% if topic.based_on %}
                        {% url 'topics_detail' username=topic.based_on.created_by.username slug=topic.based_on.slug as based_on_url %}
                        {% blocktrans with created_date=topic.created_at|date created_by=topic.created_by based_on_user=topic.based_on.created_by %}Created by <a class="text-info-emphasis" href="{{ user_topics_url }}">{{ created_by }}</a> on {{ created_date }}; not yet published; based on <a class="text-info-emphasis" href="{{ based_on_url }}">{{ based_on_user }}'s version</a>.{% endblocktrans %}
                    {% else %}
                        {% blocktrans with created_date=topic.created_at|date created_by=topic.created_by %}Created by <a class="text-info-emphasis" href="{{ user_topics_url }}">{{ created_by }}</a> on {{ created_date }}; not yet published.{% endblocktrans %}
                    {% endif %}
                {% endif %}

                {% if topic.status == "draft" %}
                    <span class="badge bg-warning pill ms-1">{% trans "Draft" %}</span>
                {% elif topic.status == "archived" %}
                    <span class="badge bg-secondary pill ms-1">{% trans "Archived" %}</span>
                {% endif %}

            </p>

        </div>

    </div>

    <div class="d-flex align-items-start">

        {% if is_preview %}
            {% if topic.status == 'draft' or topic.status == 'published' %}
                <button class="btn btn-outline-primary btn-sm me-1" data-topic-status-button data-topic-publish-button="true" data-status="published">
                    {% if topic.last_published_at %}
                        {% trans "Re-publish" %}
                    {% else %}
                        {% trans "Publish" %}
                    {% endif %}
                </button>
            {% endif %}
            <a class="btn btn-outline-secondary btn-sm align-self-start" href="{% url 'topics_detail_edit' topic_uuid=topic.uuid username=topic.created_by.username %}">
                {% trans "Edit" %}
            </a>
        {% else %}
            {% if topic.created_by != user %}
                <a href="{% url 'topics_clone' slug=topic.slug username=topic.created_by.username %}"
                   class="btn btn-outline-primary btn-sm ms-1"
                   data-bs-toggle="tooltip" data-bs-title="{% trans "Clone topic" %}">
                    {% trans "Clone" %}
                </a>
            {% elif user == topic.created_by %}
                {% if topic.status == 'published' %}
                    <button class="btn btn-outline-primary btn-sm me-1" data-topic-status-button data-status="archived">
                        {% trans "Archive" %}
                    </button>
                {% elif topic.status == 'archived' %}
                    <button class="btn btn-outline-primary btn-sm me-1" data-topic-status-button data-status="published">
                        {% trans "Unarchive" %}
                    </button>
                {% endif %}

                {% if topic.status == 'archived' %}
                    <a class="btn btn-outline-primary btn-sm disabled align-self-start" role="button" aria-disabled="true">
                        {% trans "Edit" %}
                    </a>
                {% else %}
                    <a class="btn btn-outline-primary btn-sm align-self-start" href="{% url 'topics_detail_edit' topic_uuid=topic.uuid username=topic.created_by.username %}">
                        {% trans "Edit" %}
                    </a>
                {% endif %}
            {% endif %}
        {% endif %}

    </div>

    <div id="publishTopicError" class="alert alert-danger small mt-2 d-none" role="alert"></div>

</div>

<div class="row">

    <div class="col-12 col-lg-8" data-layout-column="primary">

        {% for module in primary_modules %}
            {% with base_key=module.base_module_key|default:module.module_key %}
                {% if base_key == 'images' %}
                    <section
                        class="topic-module-wrapper"
                        data-module="{{ module.module_key }}"
                        data-placement="{{ module.placement }}"
                        data-display-order="{{ module|module_display_order }}"
                        data-has-content="{{ module.has_content|yesno:'true,false' }}"
                    >
                        {% render_topic_module module %}
                    </section>
                {% endif %}
            {% endwith %}
        {% endfor %}

        {% for module in primary_modules %}
            {% with base_key=module.base_module_key|default:module.module_key %}
                {% if base_key == 'recaps' %}
                    <section
                        class="topic-module-wrapper"
                        data-module="{{ module.module_key }}"
                        data-placement="{{ module.placement }}"
                        data-display-order="{{ module|module_display_order }}"
                        data-has-content="{{ module.has_content|yesno:'true,false' }}"
                    >
                        {% render_topic_module module %}
                    </section>
                {% endif %}
            {% endwith %}
        {% endfor %}

        {% for module in primary_modules %}
            {% with base_key=module.base_module_key|default:module.module_key %}
                {% if base_key != 'images' and base_key != 'recaps' %}
                    <section
                        class="topic-module-wrapper"
                        data-module="{{ module.module_key }}"
                        data-placement="{{ module.placement }}"
                        data-display-order="{{ module|module_display_order }}"
                        data-has-content="{{ module.has_content|yesno:'true,false' }}"
                    >
                        {% render_topic_module module %}
                    </section>
                {% endif %}
            {% endwith %}
        {% endfor %}

    </div>


    <div class="col-12 col-lg-4" data-layout-column="sidebar">

        {% for module in sidebar_modules %}
            <section
                class="topic-module-wrapper"
                data-module="{{ module.module_key }}"
                data-placement="{{ module.placement }}"
                data-display-order="{{ module|module_display_order }}"
                data-has-content="{{ module.has_content|yesno:'true,false' }}"
            >
                {% render_topic_module module %}
            </section>
        {% endfor %}

    </div>

</div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="{% static 'topics/topic_events.js' %}"></script>
    <script src="{% static 'topics/topic_publish.js' %}"></script>
    <script src="{% static 'topics/generation_button.js' %}"></script>
    {% include "topics/recaps/scripts.html" %}
    {% include "topics/data/scripts.html" %}
    {% include "topics/text/scripts.html" %}
    {% include "topics/images/scripts.html" %}
    {% include "topics/webcontent/documents/scripts.html" %}
    {% include "topics/relations/scripts.html" %}
    {% include "topics/timeline/scripts.html" %}
    {% include "topics/mcps/scripts.html" %}
{% endblock %}
