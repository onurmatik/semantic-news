{% extends "base.html" %}

{% load static i18n humanize markdown_extras topic_layout %}

{% block title %}{{ topic.display_title }}{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
{% endblock %}

{% block content %}

<div class="pb-2">

    <div
        data-topic-uuid="{{ topic.uuid }}"
        data-topic-slug="{{ topic.slug|default:'' }}"
        data-topic-title="{{ topic.title|default_if_none:'' }}"
        data-topic-has-unpublished-changes="{{ topic.has_unpublished_changes|yesno:'true,false' }}"
    >

        <h3 class="fs-5 d-flex align-items-center">

            <span class="d-md-inline">
            {% for keyword in topic.categories.all %}
                <a href="{% url 'topics_detail' slug=keyword.slug %}" class="text-info-emphasis text-decoration-none">{{ keyword.name }}</a>
                {% if not forloop.last %}
                    &middot;
                {% endif %}
            {% endfor %}
            </span>

        </h3>

        <div class="d-flex flex-column gap-3">

            <div class="alert alert-light d-flex align-items-center justify-content-between gap-2 flex-wrap" data-topic-toolbar>
                <div class="d-flex align-items-center flex-wrap gap-2 small text-secondary">
                    <span>
                        {% blocktrans with created_date=topic.created_at|date modified_ago=topic.updated_at|timesince %}Created on {{ created_date }} · Updated {{ modified_ago }} ago{% endblocktrans %}
                    </span>
                    {% if topic.based_on %}
                        {% url 'topics_detail' username=topic.based_on.created_by.username slug=topic.based_on.slug as based_on_url %}
                        <span>
                            {% blocktrans trimmed with based_on_url=based_on_url %}Based on <a class="text-info-emphasis" href="{{ based_on_url }}">previous version</a>.{% endblocktrans %}
                        </span>
                    {% endif %}
                    {% if topic.status == "draft" %}
                        <span class="badge bg-warning rounded-pill">{% trans "Draft" %}</span>
                    {% elif topic.status == "archived" %}
                        <span class="badge bg-secondary rounded-pill">{% trans "Archived" %}</span>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if topic.status == 'draft' or topic.status == 'published' %}
                        <a
                            class="btn btn-outline-primary btn-sm"
                            href="{% url 'topics_detail_preview' topic_uuid=topic.uuid username=topic.created_by.username %}"
                        >
                            {% trans "Preview" %}
                        </a>
                    {% endif %}
                    <a class="btn btn-outline-secondary btn-sm" href="{{ topic.get_absolute_url }}">
                        <i class="bi bi-x-lg"></i>
                    </a>
                </div>
            </div>

            <form id="topicTitleForm" class="d-flex align-items-center gap-3 flex-wrap" novalidate>
                <label class="visually-hidden" for="topicTitleInput">{% trans "Topic title" %}</label>
                <div class="flex-grow-1">
                    <div
                        id="topicTitleInput"
                        class="fw-semibold fs-4 px-0 pb-1 border-0 border-bottom border-1 border-dark-subtle rounded-0"
                        role="textbox"
                        contenteditable="true"
                        spellcheck="true"
                        data-untitled="{% trans "Untitled" %}"
                        data-placeholder-active="false"
                        aria-label="{% trans "Topic title" %}"
                        aria-multiline="false"
                        data-maxlength="200"
                    >{{ topic.title|default_if_none:'' }}</div>
                </div>
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <span
                        class="d-inline-flex align-items-center text-secondary"
                        id="topicTitleStatus"
                        aria-live="polite"
                    >
                        <i id="topicTitleStatusIcon" class="bi bi-pencil" aria-hidden="true"></i>
                        <span
                            class="visually-hidden"
                            id="topicTitleStatusText"
                            data-message-idle="{% trans "Title ready to edit." %}"
                            data-message-saving="{% trans "Saving title…" %}"
                            data-message-success="{% trans "Title saved." %}"
                            data-message-error="{% trans "Unable to update the topic title." %}"
                        >{% trans "Title ready to edit." %}</span>
                    </span>
                    <button
                        class="btn btn-outline-secondary btn-sm"
                        type="button"
                        id="topicTitleSuggestBtn"
                        title="{% trans "Suggest title" %}"
                        aria-label="{% trans "Suggest title" %}"
                    >
                        <i class="bi bi-stars" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="invalid-feedback d-none w-100" id="editTopicTitleError"></div>
            </form>

            <div id="publishTopicError" class="alert alert-danger small d-none mt-2" role="alert"></div>

        </div>

    </div>

</div>

<div
    class="row"
    data-topic-layout
    data-topic-uuid="{{ topic.uuid }}"
    data-layout-api-url="{{ layout_update_url }}"
    data-layout-editable="true"
>

    <div class="col-12 col-lg-8 d-flex flex-column gap-3" data-layout-column="primary">

        {% for module in primary_modules %}
            {% if module.base_module_key == 'images' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="primary"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        {% for module in primary_modules %}
            {% if module.base_module_key == 'recaps' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="primary"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        {% for module in primary_modules %}
            {% if module.base_module_key == 'content_toolbar' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="primary"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        <div class="d-flex flex-column gap-3" data-layout-list>
            {% for module in primary_modules %}
                {% if module.base_module_key|is_reorderable_module %}
                    <section
                        class="topic-module-wrapper"
                        data-module="{{ module.module_key }}"
                        data-base-module="{{ module.base_module_key }}"
                        data-placement="primary"
                        data-display-order="{{ module.display_order }}"
                        data-has-content="{{ module.has_content|yesno:'true,false' }}"
                        data-layout-reorderable="true"
                    >
                        {% render_topic_module module %}
                    </section>
                {% endif %}
            {% endfor %}
        </div>

        {% for module in primary_modules %}
            {% if not module.base_module_key|is_primary_fixed_module and not module.base_module_key|is_reorderable_module and module.base_module_key != 'entities' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="{{ module.placement }}"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        {% include "topics/covers/confirm_delete.html" %}
        {% include "topics/text/confirm_delete.html" %}
        {% include "topics/entities/confirm_delete.html" %}
        {% include "topics/timeline/confirm_delete.html" %}

    </div>


    <div class="col-12 col-lg-4 d-flex flex-column gap-3" data-layout-column="sidebar">

        {% for module in primary_modules %}
            {% if module.base_module_key == 'entities' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="sidebar"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        {% for module in sidebar_modules %}
            {% if module.base_module_key == 'entities' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="sidebar"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        {% for module in sidebar_modules %}
            {% if module.base_module_key == 'timeline' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="sidebar"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        {% for module in sidebar_modules %}
            {% if module.base_module_key == 'related_topics' %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="sidebar"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

        {% for module in sidebar_modules %}
            {% if not module.base_module_key|is_sidebar_fixed_module %}
                <section
                    class="topic-module-wrapper"
                    data-module="{{ module.module_key }}"
                    data-base-module="{{ module.base_module_key }}"
                    data-placement="{{ module.placement }}"
                    data-display-order="{{ module.display_order }}"
                    data-has-content="{{ module.has_content|yesno:'true,false' }}"
                >
                    {% render_topic_module module %}
                </section>
            {% endif %}
        {% endfor %}

    </div>

</div>


{% include "topics/mcps/modal.html" %}
{% comment %} Inline editors render in the content area {% endcomment %}
{% include "topics/data/analyze_modal.html" %}
{% include "topics/data/visualize_modal.html" %}
{% include "topics/covers/modal.html" %}
{% include "topics/entities/modal.html" %}
{% include "topics/timeline/modal.html" %}
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="{% static 'topics/topic_events.js' %}"></script>
    <script src="{% static 'topics/topic_publish.js' %}"></script>
    <script src="{% static 'topics/topic_title.js' %}"></script>
    <script src="{% static 'topics/generation_button.js' %}"></script>
    <script src="{% static 'topics/related_topics.js' %}"></script>
    <script src="{% static 'topics/layout.js' %}"></script>
    {% include "topics/recaps/scripts.html" %}
    <script src="{% static 'topics/content/toolbar.js' %}"></script>
    <script src="{% static 'topics/content/external_content.js' %}"></script>
    {% include "topics/data/scripts.html" %}
    {% include "topics/text/scripts.html" %}
    {% include "topics/covers/scripts.html" %}
    {% include "topics/entities/scripts.html" %}
    {% include "topics/timeline/scripts.html" %}
    {% include "topics/mcps/scripts.html" %}
    <script src="{% static 'topics/status_checker.js' %}"></script>
{% endblock %}
