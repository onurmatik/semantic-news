{% extends "base.html" %}

{% load static i18n humanize markdown_extras topic_layout %}

{% block title %}{{ topic.display_title }}{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
{% endblock %}

{% block content %}

<div class="pb-2">

    <div
        data-topic-uuid="{{ topic.uuid }}"
        data-topic-slug="{{ topic.slug|default:'' }}"
        data-topic-title="{{ topic.title|default_if_none:'' }}"
        data-topic-has-unpublished-changes="{{ topic.has_unpublished_changes|yesno:'true,false' }}"
    >

        <h3 class="fs-5 d-flex align-items-center">

            <span class="d-md-inline">
            {% for keyword in topic.categories.all %}
                <a href="{% url 'topics_detail' slug=keyword.slug %}" class="text-info-emphasis text-decoration-none">{{ keyword.name }}</a>
                {% if not forloop.last %}
                    &middot;
                {% endif %}
            {% endfor %}
            </span>

        </h3>

        <div class="d-flex flex-column gap-3">

            <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap" data-topic-toolbar>
                <div class="d-flex align-items-center flex-wrap gap-2 small text-secondary">
                    <span>
                        {% blocktrans with created_date=topic.created_at|date modified_ago=topic.updated_at|timesince %}Created on {{ created_date }} Â· Updated {{ modified_ago }} ago{% endblocktrans %}
                    </span>
                    {% if topic.based_on %}
                        {% url 'topics_detail' username=topic.based_on.created_by.username slug=topic.based_on.slug as based_on_url %}
                        <span>
                            {% blocktrans trimmed with based_on_url=based_on_url %}Based on <a class="text-info-emphasis" href="{{ based_on_url }}">previous version</a>.{% endblocktrans %}
                        </span>
                    {% endif %}
                    {% if topic.status == "draft" %}
                        <span class="badge bg-warning rounded-pill">{% trans "Draft" %}</span>
                    {% elif topic.status == "archived" %}
                        <span class="badge bg-secondary rounded-pill">{% trans "Archived" %}</span>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if topic.status == 'draft' or topic.status == 'published' %}
                        <a
                            class="btn btn-outline-primary btn-sm"
                            href="{% url 'topics_detail_preview' topic_uuid=topic.uuid username=topic.created_by.username %}"
                        >
                            {% trans "Preview" %}
                        </a>
                    {% endif %}
                    <a class="btn btn-outline-secondary btn-sm" href="{{ topic.get_absolute_url }}">
                        {% trans "Exit" %}
                    </a>
                </div>
            </div>

            <form id="topicTitleForm" class="d-flex align-items-center gap-2 flex-wrap" novalidate>
                <label class="visually-hidden" for="topicTitleInput">{% trans "Topic title" %}</label>
                <input
                    type="text"
                    class="form-control form-control-lg border-0 px-0 fw-semibold flex-grow-1"
                    id="topicTitleInput"
                    name="title"
                    value="{{ topic.title|default_if_none:'' }}"
                    maxlength="200"
                    autocomplete="off"
                    placeholder="{% trans "Untitled" %}"
                    data-untitled="{% trans "Untitled" %}"
                >
                <button
                    class="btn btn-outline-secondary btn-sm"
                    type="button"
                    id="topicTitleSuggestBtn"
                    title="{% trans "Suggest title" %}"
                    aria-label="{% trans "Suggest title" %}"
                >
                    <i class="bi bi-stars" aria-hidden="true"></i>
                </button>
                <button type="submit" class="btn btn-primary btn-sm">{% trans "Save title" %}</button>
                <div class="invalid-feedback d-none w-100" id="editTopicTitleError"></div>
            </form>

            <div id="publishTopicError" class="alert alert-danger small d-none mt-2" role="alert"></div>

        </div>

    </div>

</div>

<div class="alert alert-warning d-flex justify-content-between align-items-center p-2 flex-wrap gap-2">
    <span class="small text-secondary">
        {% if topic.status == "published" and topic.last_published_at %}
            {% blocktrans with published_on=topic.last_published_at|date published_ago=topic.last_published_at|timesince %}Published on {{ published_on }}; {{ published_ago }} ago.{% endblocktrans %}
        {% else %}
            {% blocktrans with topic_status=topic.status %}This topic is {{ topic_status }}.{% endblocktrans %}
        {% endif %}
    </span>
</div>

<div
    class="row"
    data-topic-layout
    data-topic-uuid="{{ topic.uuid }}"
    data-layout-api-url="{{ layout_update_url }}"
    data-layout-editable="true"
>

    <div class="col-12 col-lg-8" data-layout-column="primary">

        {% for module in primary_modules %}
            <section
                class="topic-module-wrapper"
                data-module="{{ module.module_key }}"
                data-placement="{{ module.placement }}"
                data-display-order="{{ module.display_order }}"
                data-has-content="{{ module.has_content|yesno:'true,false' }}"
            >
                {% render_topic_module module %}
            </section>
        {% endfor %}

        {% include "topics/images/confirm_delete.html" %}
        {% include "topics/text/confirm_delete.html" %}
        {% include "topics/relations/confirm_delete.html" %}
        {% include "topics/timeline/confirm_delete.html" %}

    </div>


    <div class="col-12 col-lg-4" data-layout-column="sidebar">

        {% for module in sidebar_modules %}
            <section
                class="topic-module-wrapper"
                data-module="{{ module.module_key }}"
                data-placement="{{ module.placement }}"
                data-display-order="{{ module.display_order }}"
                data-has-content="{{ module.has_content|yesno:'true,false' }}"
            >
                {% render_topic_module module %}
            </section>
        {% endfor %}

    </div>

</div>


{% include "topics/mcps/modal.html" %}
{% include "topics/documents/modal.html" %}
{% include "topics/data/modal.html" %}
{% include "topics/data/analyze_modal.html" %}
{% include "topics/data/visualize_modal.html" %}
{% include "topics/text/modal.html" %}
{% include "topics/images/modal.html" %}
{% include "topics/embeds/modal.html" %}
{% include "topics/relations/modal.html" %}
{% include "topics/timeline/modal.html" %}
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="{% static 'topics/topic_events.js' %}"></script>
    <script src="{% static 'topics/topic_publish.js' %}"></script>
    <script src="{% static 'topics/topic_title.js' %}"></script>
    <script src="{% static 'topics/generation_button.js' %}"></script>
    <script src="{% static 'topics/related_topics.js' %}"></script>
    <script src="{% static 'topics/layout.js' %}"></script>
    {% include "topics/recaps/scripts.html" %}
    {% include "topics/data/scripts.html" %}
    {% include "topics/documents/scripts.html" %}
    {% include "topics/text/scripts.html" %}
    {% include "topics/images/scripts.html" %}
    {% include "topics/embeds/scripts.html" %}
    {% include "topics/relations/scripts.html" %}
    {% include "topics/timeline/scripts.html" %}
    {% include "topics/mcps/scripts.html" %}
    <script src="{% static 'topics/status_checker.js' %}"></script>
{% endblock %}
